{% extends 'base.html' %} {% block title %}Eşya Zaman Çizelgesi - {{ beach.name
}}{% endblock %} {% block content %}
<style>
  /* Sadece temel renklendirme için basit stiller */
  .schedule-table th,
  .schedule-table td {
    min-width: 65px;
    text-align: center;
    vertical-align: middle;
    font-size: 0.9rem;
  }
  .item-name-col {
    min-width: 180px;
    font-weight: bold;
    text-align: left !important;
  }
  .slot-available {
    background-color: #d1e7dd; /* Açık Yeşil */
  }
  .slot-booked {
    background-color: #f8d7da; /* Açık Kırmızı */
  }

.modal-backdrop {
    display: none; /* Varsayılan olarak gizli */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
}
.modal-content {
    display: none; /* Varsayılan olarak gizli */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    z-index: 1050;
    width: 90%;
    max-width: 500px;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.modal-body {
    margin-bottom: 20px;
}
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px; /* Butonlar arası boşluk */
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}
</style>

<div class="container-fluid mt-4">
  <h2 class="mb-4">
    Eşya Zaman Çizelgesi: <span class="text-primary">{{ beach.name }}</span>
  </h2>

  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" action="{{ url_for('beach_admin.item_schedule') }}">
        <div class="row align-items-end">
          <div class="col-md-4">
            <label for="date" class="form-label">Tarih Seçin</label>
            <input
                type="date"
                class="form-control"
                id="date"
                name="date"
                value="{{ selected_date }}"
            />
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Göster</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered schedule-table" id="schedule-table">
      <thead class="table-light">
        <tr>
          <th class="item-name-col">Eşya</th>

          {% for hour in hours %}
          <th>{{ hour }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for item_id, data in schedule.items() %}
        <tr>
          <td class="item-name-col">
            {{ data.item_info.item_type.replace('_', ' ')|title }} #{{
            data.item_info.item_number }}
          </td>

          {% for hour_key, slot_info in data.slots.items() %} {# --- GÜNCELLEME
          BURADA BAŞLIYOR --- #}
          <td
            class="time-slot status-{{ slot_info.status|default('free') }}"
            data-item-id="{{ item_id }}"
            data-date="{{ selected_date }}"
            data-time="{{ hour_key }}"
            data-status="{{ slot_info.status|default('free') }}"
            data-reservation-id="{{ slot_info.reservation_id or '' }}"
            data-user-info="{{ slot_info.user_info or '' }}"
          >
            {# Doluysa, kimin rezerve ettiğini gösterelim #} {% if
            slot_info.status != 'free' %} {{ slot_info.user_info or 'Dolu' }} {%
            else %} &nbsp; {# Boşsa boş kalsın #} {% endif %}
          </td>
          {# --- GÜNCELLEME BURADA BİTİYOR --- #} {% endfor %}
        </tr>
        {% endfor %} {% if not schedule %}
        <tr>
          <td colspan="{{ hours|length + 1 }}" class="text-center p-4">
            Bu plaj için gösterilecek eşya bulunamadı.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{# MODAL HTML YAPISI BURAYA EKLENECEK #}
<div id="schedule-modal-backdrop" class="modal-backdrop"></div>
<div id="schedule-modal" class="modal-content">
    <div class="modal-header">
        <h5 id="modal-title">Eşya Durumu</h5>
        <button type="button" id="modal-close-btn" class="btn-close"></button>
    </div>
    <div id="modal-body" class="modal-body">
        <p>İçerik buraya yüklenecek...</p>
    </div>
    <div id="modal-footer" class="modal-footer">
        {# Butonlar JavaScript ile dinamik olarak buraya eklenecek #}
    </div>
</div>
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modal elementlerini seç
    const backdrop = document.getElementById('schedule-modal-backdrop');
    const modal = document.getElementById('schedule-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalFooter = document.getElementById('modal-footer');
    const closeBtn = document.getElementById('modal-close-btn');
    const scheduleTable = document.getElementById('schedule-table');

    // Modal'ı kapatma fonksiyonu
    function closeModal() {
        modal.style.display = 'none';
        backdrop.style.display = 'none';
    }

    // Kapatma butonlarına ve arka plana tıklama olayı ekle
    closeBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);

    if (scheduleTable) {
        scheduleTable.addEventListener('click', function(event) {
            if (event.target.matches('td.time-slot')) {
                const cell = event.target;
                const cellData = {
                    itemId: cell.dataset.itemId,
                    date: cell.dataset.date,
                    time: cell.dataset.time,
                    status: cell.dataset.status,
                    reservationId: cell.dataset.reservationId,
                    userInfo: cell.dataset.userInfo
                };
                
                // --- MODAL'I DOLDURMA ---
                const itemInfo = cell.closest('tr').querySelector('.item-name-col').textContent.trim();
                modalTitle.textContent = `${itemInfo} - Saat: ${cellData.time}`;

                // Modal içeriğini oluştur
                let bodyHtml = `<p><strong>Durum:</strong> <span class="text-capitalize">${cellData.status}</span></p>`;
                if (cellData.userInfo) {
                    bodyHtml += `<p><strong>Kullanıcı:</strong> ${cellData.userInfo}</p>`;
                }
                modalBody.innerHTML = bodyHtml;

                // Modal butonlarını duruma göre oluştur
                modalFooter.innerHTML = ''; // Önceki butonları temizle

                if (cellData.status === 'free') {
                    const reserveButton = document.createElement('button');
                    reserveButton.className = 'btn btn-primary';
                    reserveButton.textContent = 'Rezervasyon Yap';
                    modalFooter.appendChild(reserveButton);
                } else { // reserved veya used
                    const useButton = document.createElement('button');
                    useButton.className = 'btn btn-success';
                    useButton.textContent = 'Kullanımda Yap';
                    useButton.disabled = cellData.status === 'used'; // Zaten kullanımdaysa pasif yap
                    modalFooter.appendChild(useButton);

                    const cancelButton = document.createElement('button');
                    cancelButton.className = 'btn btn-danger';
                    cancelButton.textContent = 'Rezervasyonu İptal Et';
                    modalFooter.appendChild(cancelButton);
                }
                
                // --- MODAL'I GÖSTERME ---
                modal.style.display = 'block';
                backdrop.style.display = 'block';
            }
        });
    }
});
</script>
{% endblock %} {% endblock %}
