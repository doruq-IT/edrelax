{% extends 'base.html' %} {% block title %}Şezlong Doluluk Takvimi - {{
beach.name }}{% endblock %} {% block content %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .status-free {
    background-color: #7fe37c !important;
    color: black;
    font-weight: bold;
  }
  .status-reserved {
    background-color: #ff7f7f !important;
    color: darkred;
    font-weight: bold;
  }
  .status-used {
    background-color: #87cefa !important;
    color: darkblue;
    font-weight: bold;
  }
  .status-cancelled {
    background-color: #d3d3d3 !important;
    color: dimgray;
    font-weight: bold;
  }
  .status-unknown {
    background-color: #fffacd !important;
    color: goldenrod;
    font-weight: bold;
  }
  .bed-slot {
    cursor: pointer;
    transition: filter 0.2s ease-in-out;
  }
  .bed-slot:hover {
    filter: brightness(0.9);
  }
  .swal2-select {
    margin: 1em auto;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  .slot-selected {
    outline: 2px solid #007bff;
    outline-offset: -2px;
    background-color: #cfe2ff !important;
  }
</style>

<div
  class="container mt-5"
  id="bedScheduleContainer"
  data-beach-id="{{ beach.id }}"
  data-beach-name="{{ beach.name }}"
>
  <h2 class="mb-4 text-center">{{ beach.name }} - Şezlong Doluluk Takvimi</h2>

  <form method="get" class="mb-4 text-center">
    <label for="date">Tarih:</label>
    <input
      type="date"
      name="date"
      id="scheduleDate"
      value="{{ selected_date }}"
      required
    />
    <button type="submit" class="btn btn-primary btn-sm">Görüntüle</button>
  </form>

  <div class="multi-select-controls mb-3 text-center">
    <button
      type="button"
      class="btn btn-info btn-sm"
      id="toggleMultiSelectModeBtn"
    >
      Çoklu Saat Seçimini Aktif Et</button
    >,
    <button
      type="button"
      class="btn btn-success btn-sm"
      id="applyToSelectedBtn"
      style="display: none"
    >
      Seçilenlere Durum Uygula
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Şezlong</th>
          {% for hour in hours %}
          <th>{{ hour }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for bed_num, hour_map in bed_schedule.items() %}
        <tr>
          <td><strong>{{ bed_num | to_alphanumeric_bed_id }}</strong></td>
          {% for hour_key in hours %} {% set slot_info = hour_map.get(hour_key,
          {"status": "free", "time": hour_key, "reservation_id": None,
          "user_info": None}) %}
          <td
            class="bed-slot status-{{ slot_info.status | lower | replace(' ', '-') }}"
            data-bed-number="{{ bed_num }}"
            data-time-slot="{{ hour_key }}"
            data-current-status="{{ slot_info.status }}"
            {%
            if
            slot_info.reservation_id
            %}
            data-reservation-id="{{ slot_info.reservation_id }}"
            data-user-email="{{ slot_info.user_email }}"
            data-user-info="{{ slot_info.user_info }}"
            {#
            YENİ:
            Bu
            satırı
            ekleyin
            #}
            title="Kullanıcı: {{ slot_info.user_info or 'Bilinmiyor' }} | Durum: {{ slot_info.status }} | ID: {{ slot_info.reservation_id }}"
            {%
            else
            %}
            title="Durum: Boş ({{ hour_key }})"
            {%
            endif
            %}
          >
            {% if slot_info.status == 'reserved' %} Rezerve {% elif
            slot_info.status == 'used' %} Kullanımda {% elif slot_info.status ==
            'cancelled' %} İptal {% elif slot_info.status == 'free' %} Boş {%
            else %} {{ slot_info.status | capitalize if slot_info.status else
            'Hata' }} {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ===============================================================
    // DEĞİŞKENLER VE TEMEL KURULUM
    // ===============================================================

    // --- Socket.IO Kurulumu ---
    const socket = io();
    socket.on('connect', () => console.log('Socket.IO sunucusuna başarıyla bağlanıldı!'));

    // --- DOM Elementleri ---
    const bedScheduleContainer = document.getElementById('bedScheduleContainer');
    const scheduleDateInput = document.getElementById('scheduleDate');
    const toggleMultiSelectModeBtn = document.getElementById('toggleMultiSelectModeBtn');
    const applyToSelectedBtn = document.getElementById('applyToSelectedBtn');
    const bedSlots = document.querySelectorAll('.bed-slot');

    // --- Sayfa Bilgileri ---
    const beachId = bedScheduleContainer.dataset.beachId;
    const beachName = bedScheduleContainer.dataset.beachName || "Plajımız";

    // --- Durum ve Seçenekler ---
    const statusOptions = {
        'reserved': 'Rezerve Et',
        'used': 'Kullanımda Olarak İşaretle',
        'free': 'Boş Olarak İşaretle (Rezervasyonu Sil)'
        // 'cancelled' durumu gerekirse eklenebilir. Backend bunu destekliyor.
    };
    let isMultiSelectModeActive = false;
    let currentSelectedBedNumberForMulti = null;
    let currentlySelectedSlots = [];

    // --- Yardımcılar (SweetAlert Toast) ---
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer);
            toast.addEventListener('mouseleave', Swal.resumeTimer);
        }
    });

    // ===============================================================
    // SOCKET.IO DİNLEYİCİLERİ (REAL-TIME GÜNCELLEMELER)
    // ===============================================================

    // 1. TEKİL GÜNCELLEME DİNLEYİCİSİ (Değişmedi)
    // Başka bir adminin tek bir slota tıklamasıyla gelen güncellemeyi yakalar.
    socket.on('status_updated', function (data) {
        console.log('Tekil anlık güncelleme geldi:', data);
        if (isUpdateForCurrentPage(data)) {
            const selector = `.bed-slot[data-bed-number="${data.bed_number}"][data-time-slot="${data.time_slot}"]`;
            const cellToUpdate = document.querySelector(selector);
            if (cellToUpdate) {
                updateCellUI(cellToUpdate, data);
                Toast.fire({
                    icon: 'info',
                    title: `Şezlong #${data.bed_number} (${data.time_slot}) durumu güncellendi.`
                });
            }
        }
    });

    // 2. ÇOKLU GÜNCELLEME DİNLEYİCİSİ (YENİ)
    // Başka bir adminin "Tüm Seçilenlere Uygula" butonuna basmasıyla gelen toplu güncellemeyi yakalar.
    socket.on('multi_status_updated', function (data) {
        console.log('Toplu anlık güncelleme geldi:', data);
        if (data.updates && data.updates.length > 0 && isUpdateForCurrentPage(data.updates[0])) {
            data.updates.forEach(update => {
                const selector = `.bed-slot[data-bed-number="${update.bed_number}"][data-time-slot="${update.time_slot}"]`;
                const cellToUpdate = document.querySelector(selector);
                if (cellToUpdate) {
                    updateCellUI(cellToUpdate, update);
                }
            });
            Toast.fire({
                icon: 'info',
                title: `${data.updates.length} adet saat dilimi güncellendi.`
            });
        }
    });

    // ===============================================================
    // OLAY YÖNETİCİLERİ (EVENT LISTENERS)
    // ===============================================================

    // Çoklu seçim modunu aç/kapa
    toggleMultiSelectModeBtn.addEventListener('click', function () {
        isMultiSelectModeActive = !isMultiSelectModeActive;
        this.textContent = isMultiSelectModeActive ? 'Çoklu Seçimi Pasif Et' : 'Çoklu Saat Seçimini Aktif Et';
        this.classList.toggle('btn-info', !isMultiSelectModeActive);
        this.classList.toggle('btn-warning', isMultiSelectModeActive);
        clearCurrentMultiSelection();
        updateApplyToSelectedButtonState();
    });
    
    // Çoklu seçim için "Tüm Seçilenlere Uygula" butonu (YENİDEN YAZILDI)
    applyToSelectedBtn.addEventListener('click', function () {
        if (currentlySelectedSlots.length === 0) return;

        const firstSlot = currentlySelectedSlots[0];
        const bedNumber = firstSlot.dataset.bedNumber;
        const userInfo = firstSlot.dataset.userInfo;
        const userEmail = firstSlot.dataset.userEmail;
        const showMailButton = (userEmail && userEmail !== 'None');

        let alertHtml = `<p><b>${currentlySelectedSlots.length} adet</b> seçili saat dilimine uygulanacak yeni durumu seçin:</p>`;
        if (userInfo && userInfo !== 'None') alertHtml += `<p>Müşteri: <strong>${userInfo}</strong></p>`;
        if (userEmail && userEmail !== 'None') alertHtml += `<p>E-posta: <strong>${userEmail}</strong></p>`;

        Swal.fire({
            title: `Şezlong #${bedNumber}`,
            html: alertHtml,
            input: 'select',
            inputOptions: statusOptions,
            inputPlaceholder: 'Durum Seçin',
            showCancelButton: true,
            confirmButtonText: 'Tümüne Uygula',
            cancelButtonText: 'Vazgeç',
            showDenyButton: showMailButton,
            denyButtonText: 'Müşteriye Mail Gönder',
            inputValidator: (value) => !value && 'Bir durum seçmelisiniz!'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                // ARTIK ÇOKLU İSTEK YERİNE, TEK BİR İSTEK GÖNDEREN YENİ FONKSİYONU ÇAĞIRIYORUZ.
                updateMultipleStatusesOnServer(currentlySelectedSlots, result.value);
            } else if (result.isDenied) {
                // Mail gönderme mantığı değişmedi.
                const timeSlotsString = currentlySelectedSlots.map(s => s.dataset.timeSlot).join(', ');
                const mailSubject = encodeURIComponent(`Şezlong Rezervasyonunuz Hk. - ${beachName}`);
                const mailBody = encodeURIComponent(`Merhaba ${userInfo || ''},\n\nRezervasyon Detayları:\nPlaj: ${beachName}\nŞezlong: #${bedNumber}\nTarih: ${scheduleDateInput.value}\nSaatler: ${timeSlotsString}\n\nSaygılarımızla,\n${beachName} Ekibi`);
                window.location.href = `mailto:${userEmail}?subject=${subject}&body=${mailBody}`;
            }
        });
    });

    // Her bir saat dilimine (slot) tıklama olayı
    bedSlots.forEach(slot => {
        slot.addEventListener('click', function () {
            if (isMultiSelectModeActive) {
                handleMultiSelection(this);
            } else {
                handleSingleSelection(this);
            }
        });
    });

    // ===============================================================
    // FONKSİYONLAR
    // ===============================================================

    /** Çoklu seçim modunda bir slota tıklandığında seçimi yönetir. */
    function handleMultiSelection(clickedSlot) {
        const clickedBedNum = clickedSlot.dataset.bedNumber;
        if (currentSelectedBedNumberForMulti !== null && currentSelectedBedNumberForMulti !== clickedBedNum) {
            clearCurrentMultiSelection();
        }
        currentSelectedBedNumberForMulti = clickedBedNum;

        const selectionIndex = currentlySelectedSlots.indexOf(clickedSlot);
        if (selectionIndex > -1) {
            currentlySelectedSlots.splice(selectionIndex, 1);
            clickedSlot.classList.remove('slot-selected');
        } else {
            currentlySelectedSlots.push(clickedSlot);
            clickedSlot.classList.add('slot-selected');
        }
        updateApplyToSelectedButtonState();
    }

    /** Tekli seçim modunda bir slota tıklandığında pop-up açar. */
    function handleSingleSelection(clickedSlot) {
        const { bedNumber, bedDisplayId, timeSlot, currentStatus, reservationId, userEmail, userInfo } = clickedSlot.dataset;
        const showMailButton = (reservationId && userEmail && userEmail !== 'None');

        Swal.fire({
            title: `Şezlong ${bedDisplayId || '#' + bedNumber} (${timeSlot})`,
            html: `<p>Mevcut Durum: <strong>${currentStatus.toUpperCase()}</strong>.</p>${reservationId ? `<p>Müşteri: <strong>${userInfo || 'Bilinmiyor'}</strong></p>` : ''}<p>Yeni durumu seçin:</p>`,
            input: 'select',
            inputOptions: statusOptions,
            inputPlaceholder: 'Durum Seçin',
            showCancelButton: true,
            confirmButtonText: 'Durumu Güncelle',
            showDenyButton: showMailButton,
            denyButtonText: 'Müşteriye Mail Gönder',
            cancelButtonText: 'Vazgeç',
            inputValidator: (value) => !value && 'Bir durum seçmelisiniz!'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                updateStatusOnServer(clickedSlot, reservationId, result.value, bedNumber, timeSlot);
            } else if (result.isDenied) {
                const mailSubject = encodeURIComponent(`Şezlong Rezervasyonunuz Hk. - ${beachName}`);
                const mailBody = encodeURIComponent(`Merhaba ${userInfo || ''},\n\nRezervasyon Detayları:\nPlaj: ${beachName}\nŞezlong: #${bedNumber}\nTarih: ${scheduleDateInput.value}\nSaat: ${timeSlot}\n\nSaygılarımızla,\n${beachName} Ekibi`);
                window.location.href = `mailto:${userEmail}?subject=${mailSubject}&body=${mailBody}`;
            }
        });
    }

    /** TEK BİR slotun durumunu sunucuda günceller. */
    function updateStatusOnServer(cellElement, reservationId, newStatus, bedNumber, timeSlot) {
        const payload = { reservation_id: reservationId, new_status: newStatus };
        if (!reservationId && newStatus !== 'free') {
            Object.assign(payload, {
                bed_number: parseInt(bedNumber),
                beach_id: parseInt(beachId),
                date: scheduleDateInput.value,
                time_slot: timeSlot
            });
        }

        fetch('/beach-admin/update-reservation-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Sunucu zaten 'status_updated' yayını yapacak. Biz sadece aktif tarayıcıda UI'ı güncelliyoruz.
                updateCellUI(cellElement, data); 
                Swal.fire('Başarılı!', data.message, 'success');
            } else {
                Swal.fire('Hata!', data.message || 'Durum güncellenemedi.', 'error');
            }
        })
        .catch(error => {
            console.error('Fetch Hatası:', error);
            Swal.fire('Sunucu Hatası!', 'İletişim kurulamadı, lütfen tekrar deneyin.', 'error');
        });
    }

    /** ÇOKLU slotun durumunu sunucuda TEK BİR İSTEKLE günceller. (YENİ) */
    function updateMultipleStatusesOnServer(selectedSlotElements, newStatus) {
        const payload = {
            new_status: newStatus,
            beach_id: parseInt(beachId),
            bed_number: parseInt(selectedSlotElements[0].dataset.bedNumber),
            date: scheduleDateInput.value,
            time_slots: selectedSlotElements.map(slot => slot.dataset.timeSlot)
        };

        fetch('/beach-admin/update-reservation-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Sunucu 'multi_status_updated' yayını yapacak. Aktif tarayıcıyı yanıttan güncelliyoruz.
                data.updated_slots.forEach(updateInfo => {
                    const cellEl = selectedSlotElements.find(el => el.dataset.timeSlot === updateInfo.time_slot);
                    if (cellEl) updateCellUI(cellEl, updateInfo);
                });
                Swal.fire('Başarılı!', data.message, 'success');
            } else {
                Swal.fire('Hata!', data.message || 'Durumlar güncellenemedi.', 'error');
            }
        })
        .catch(error => {
            console.error("Toplu güncelleme sırasında fetch hatası:", error);
            Swal.fire('Sunucu Hatası!', 'Bir hata oluştu.', 'error');
        })
        .finally(() => {
            clearCurrentMultiSelection();
            updateApplyToSelectedButtonState();
        });
    }

    /** Gelen veriye göre bir hücrenin (slot) arayüzünü günceller. */
    function updateCellUI(cellElement, data) {
        const { new_status, reservation_id, user_info } = data;
        cellElement.className = `bed-slot status-${new_status.toLowerCase().replace(/\s+/g, '-')}`;
        cellElement.dataset.currentStatus = new_status;
        cellElement.dataset.reservationId = reservation_id || '';
        cellElement.dataset.userInfo = user_info || '';

        let statusText = 'Boş';
        if (new_status === 'reserved') statusText = 'Rezerve';
        else if (new_status === 'used') statusText = 'Kullanımda';
        else if (new_status === 'cancelled') statusText = 'İptal';
        cellElement.textContent = statusText;
    }

    /** Gelen bir anlık güncellemenin bu açık sayfayı ilgilendirip ilgilendirmediğini kontrol eder. */
    function isUpdateForCurrentPage(data) {
        const currentPageBeachId = bedScheduleContainer.dataset.beachId;
        const currentPageDate = scheduleDateInput.value;
        return data.beach_id.toString() === currentPageBeachId && data.date === currentPageDate;
    }

    /** Çoklu seçim listesini temizler ve ilgili butonun durumunu günceller. */
    function clearCurrentMultiSelection() {
        currentlySelectedSlots.forEach(s => s.classList.remove('slot-selected'));
        currentlySelectedSlots = [];
        currentSelectedBedNumberForMulti = null;
    }

    /** "Tüm Seçilenlere Uygula" butonunun görünürlüğünü ayarlar. */
    function updateApplyToSelectedButtonState() {
        applyToSelectedBtn.style.display = (isMultiSelectModeActive && currentlySelectedSlots.length > 0) ? 'inline-block' : 'none';
    }
});
</script>
{% endblock %}
